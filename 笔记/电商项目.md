#### 技术特点

高并发（分布式、静态化技术、缓存技术、异步并发、池化、队列）

高可用（集群、负载均衡、限流、降级、熔断）

数据量大

业务复杂

数据安全

技术新



#### 技术选型

##### 前端：

HTML CSS  js   jquery

vuejs2.0

vue脚手架：vue-cli

前端构建工具：WebPack

前端安装包：npm

ajax框架：axios

基于vue的富文本框架：quill-editor

##### 后端：

SpringMVC  SringBoot MyBatis

Spring Cloud最新版

Redis

RabbitMQ-3.4

Elasticsearch

nginx

FastDFS 分布式文件系统（统一管理图片资源）

Mycat

Thymeleaf

mysql



#### leyou商城开发

踩坑：

不知道是不是eureka版本问题，根据springboot的版本我只能用eureka2.0.0。然后代码有变动：

```java
@SpringBootApplication(exclude={DataSourceAutoConfiguration.class, HibernateJpaAutoConfiguration.class})
```

如果只写了@SpringBootApplication，程序无法启动



#### 前端开发

##### Nginx

反向代理器

利用反向代理，就可以解决端口问题

![](E:\github\JavaStuding\笔记\nginx.PNG)

将域名设置为manage.leyou.com，其实就是把127.0.0.1反向代理到这个地址。

除了ngnix的文件中的server_name要修改外，还要修改C:\Windows\System32\drivers\etc下的hosts文件，需要管理员权限（命令行管理员输入notepad打开该文件在末尾添加127.0.0.1 manage.leyou.com即可)



#### 7/2

如果在一个地方使用了@MapperScan(....)去扫描mapper包，那就不需要在每个mapper上面加@Mapper了。

`SpringBoot整合MyBatis有一个通用mapper，需要在pom中引入mapper-spring-boot-starter依赖，就可以通过extends Mapper来使用里面自带的各种增删改查方法。`

关于通过notepad的管理员权限来修改hosts文件，第一天可以，第二天就保存失败了。解决方案是把写入权限给勾上。然后在hosts文件末尾加上127.0.0.1 api.leyou.com，这样就能获取到各种物品的json格式了。现在还有跨域问题未解决（因为从manage.leyou.com到api.leyou.com是跨域）。

解决跨域：

CORS 规范化的跨域请求方案 安全可靠

在gateway网关下面写个cors类：

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class LeyouCorsConfiguration {
    @Bean
    public CorsFilter corsFilter(){
        CorsConfiguration configuration = new CorsConfiguration();
        //允许跨域的域名 如果要携带cookie 不能写*
        configuration.addAllowedOrigin("http://manage.leyou.com");
        configuration.setAllowCredentials(true);//允许携带cookie
        configuration.addAllowedMethod("*");
        configuration.addAllowedHeader("*");

        UrlBasedCorsConfigurationSource configurationSource = new UrlBasedCorsConfigurationSource();
        configurationSource.registerCorsConfiguration("/**",configuration);
        return new CorsFilter(configurationSource);
    }
}

```

关于分页：

不像之前那样自己写分页算法，而是直接调用PageHelper中的方法，就可以完成页面转换。

在前端的http.js里面写了Vue.prototype.$http = axios; 这样其他文件就可以用$http

在新增品牌时，插入中文数据在数据库中全变成了?，但是数据库本身是utf8，并且直接命令行进行插入数据能正确显示。查找原因发现，连接数据库的url要改为：`jdbc:mysql://localhost:3306/leyou?characterEncoding=utf8`。



#### 7/3

##### 文件上传，这里特指图片上传。

nginx中的配置有变化，location不再是一个http路径，而是本地文件夹路径，好像是上传之后会把该图片存到这个路径下，这个路径和代码里的：file.transferTo( new File("E:\\" + originalFilename) )要一致。然后通过image.leyou.com/图片名 访问到的是这个路径下的图片。

#### 绕过网关进行图片上传

要在nginx里面配置

由于上传图片的请求路径是：http://api.leyou.com/api/upload/image，但是真实路径是localhost:8082/upload/image,所以要重写路径。

```conf
    server {
        listen       80;
        server_name  api.leyou.com;

        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;


        location /api/upload {
        	proxy_pass http://127.0.0.1:8082;

            rewrite "^/api/(.*)$" /$1 break;
        }

        location / {
            proxy_pass http://127.0.0.1:10010;

            root   html;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

    }
```



#### FastDFS

是一个分布式文件系统 功能丰富：

- 文件存储

- 文件同步

- 文件访问

- 存取负载均衡

- 在线扩容

FastDFS两个主要的角色：Tracker Server和Storage Server。

上传：client-->tracker-->storage的地址信息-->storage上传图片-->client(图片id)

##### 安装：

在阿里云服务器上配置，启动FastDFS:  

/etc/init.d/fdfs_trackerd start

/etc/init.d/fdfs_storaged start

启动nginx:  /usr/local/nginx/sbin/nginx

sudo /usr/local/nginx/sbin/nginx -s reload 重启nginx

netstat -unltp | grep fdfs查看要有两个



centos:

sudo yum install -y pcre pcre-devel

sudo yum install -y zlib zlib-devel

sudo yum install -y openssl openssl-devel



查看nginx和fastdfs:

ps -ef | grep fdfs

ps -ef | grep nginx



nginx.conf里面要加上user root;

还有什么tracker.conf  client.conf   mod_fastdfs.conf 里面的http_server_port全改为80端口

一定要记得关闭虚拟机的防火墙。

在Java中用fastdfs需要引入依赖：

```java
        <dependency>
            <groupId>com.github.tobato</groupId>
            <artifactId>fastdfs-client</artifactId>
        </dependency>
```



#### 7/6

SPU:Standard Product Unit(标准产品单位)是一个抽象的商品集概念，

SKU:Stock Keeping Unit(库存单位) SPU商品集因具体特性不同而细分的每个商品

表的设计：

tb_spec_param里面有cid，是为了直接和tb_category进行关联

有generic:是否是通用字段 若为true 去spu获取参数值  若为false  去sku获取参数值

![image-20200706223953731](C:\Users\zhuowei\AppData\Roaming\Typora\typora-user-images\image-20200706223953731.png)



规格参数页面

因为numeric在MySql里面是关键字，所以要加上@Column(name = "`numeric`")



#### 7/7

CategoryMapper除了继承通用Mapper外还继承了SelectByIdListMapper，来通过多个id查询出一个list:

```java
public interface CategoryMapper extends Mapper<Category>, SelectByIdListMapper<Category,Long> {

}
```



#### 7/9 & 7/10

##### 商品新增功能实现

用PageResult封装了的结果，需要调用getItems()来获取列表。



#### 7/11

##### 搭建前台系统

##### Elastic

Elasticsearch是一个分布式的全文搜索引擎。

无论是京东还是天猫，搜索功能都是由单独的微服务完成的。

9300是tcp通讯端口，集群间和TCPClient都走的它，9200是http协议的RESTful接口

前端页面字段分析：

spuId   List<Sku>展示每个商品信息

要有分类，一级分类二级分类等等：cid1,cid2,cid3

新品排序根据商品的创建时间来排序。

搜索商品，要设计一个all字段，包含title,brandName,categoryName。

specs是可搜索的规格参数



#### 7/12

feign怎么使用？ 定义client接口  在接口上添加注释@FeignClient()

因为在leyou-search的pom中引入了leyou-item-interface，所以可以继承里面的接口，而interface里面定义的接口可以暴露给调用方。

序列成json的工具：private static final ObjectMapper MAPPER = new ObjectMapper(  );

#### 7/13

又遇到重大bug，调了一下午。。。

要加这个class:

```java
@Component
public class FeignBeanFactoryPostProcessor implements BeanFactoryPostProcessor {

    @Override
    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {
        if (containsBeanDefinition(beanFactory, "feignContext", "eurekaAutoServiceRegistration")) {
            BeanDefinition bd = beanFactory.getBeanDefinition("feignContext");
            bd.setDependsOn("eurekaAutoServiceRegistration");
        }
    }

    private boolean containsBeanDefinition(ConfigurableListableBeanFactory beanFactory, String... beans) {
        return Arrays.stream(beans).allMatch(b -> beanFactory.containsBeanDefinition(b));
    }
}
```

配置好后在kibana中输入：GET /goods/_search  能看见181条记录

为了防止超时，在application.yml中加上

```
feign.client.config.default.connectTimeout: 160000000
feign.client.config.default.readTimeout: 160000000
```

##### 聚合api：

###### NativeSearchQueryBuilder

StringTerms

InternalAvg

AggregationBuilers

AggregatedPage

##### 聚合函数(Aggregation):

Elasticsearch做查询时，有一些查询满足不了我们的查询条件，这时候就需要aggregation函数，聚合函数中有两个非常重要的语法,桶（Bucket）和指标（Metric）。Bucket可以定义文档集合，可以定义一个或多个，或者在集合中嵌套着定义集合；而Metric也称为计算度量，是以从文档中提取的值为基础进行的操作。



#### 7/16

##### 页面渲染

在application.yml中设置jackson，这样响应里面就不会有null的字段。

```
jackson:
  default-property-inclusion: non_null
```

json对象转json字符串：JSON.stringfy({name:'zhangsan',age:18})==>"{"name":"zhangsan","age":18}"



#### 7/17

我想抽死自己,,,,,太粗心了   specia的参数我调用的generic的函数....  导致参数没获取到为null，然后后面的转成StringTerms的时候就失败了。



#### 7/19

#### Thymeleaf

是用来开发web和独立环境项目的现代服务器端java模板引擎。

循环：th:each

要将原本的html页面变为thymeleaf页面：

```html
<html lang="en" xmlns:th="http://www.thymeleaf.org">
```

商品详情页都在www.leyou.com/item/下，且LeyouGoodsWeb配置端口为8084。之前是所有的leyou.com都会在9002端口，所以这里要重新配一下nginx，将以item/开头的转发到8084端口去。

问题：为什么在LeyouGoodsWeb中只copy了html页面，但是浏览器还是可以正确找到css等静态资源进行渲染呢？

答：虽然访问详情页面的路径是leyou.com/item/**.html，但是里面的图片资源都是在leyou.com/img/下，此时图片的访问又会转发到9002端口，也就是portal项目，里面存有全部的静态资源。

##### 商品详情页的渲染

需要的数据有：

spu

List<Map<String,Object>> categories

brand

skus

spuDetail

List<Group> groups

paramMap:{id,name}



#### 7/20

怎样设计规格参数被选中？

要设计一个数据结构保存规格参数的选中项。

































