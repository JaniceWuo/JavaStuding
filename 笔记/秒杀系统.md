### 7/28

#### 问题：库存减1应该怎么设计？

答： 直接写sql逻辑：

```sql
@Update("UPDATE stock set stock=stock-1 where id = #{id} and stock>0");
```

执行上述sql时，mysql会自动进行行锁，会对线程进行排队，并不会并发执行。

千万不能在java逻辑里面先获取当前库存然后stock = stock - 1。因为当有多个线程进来该函数的时候，可能都判断stock>0，之后都进行了stock-1操作，这样导致用户提交订单都成功了，但是数据库里面的库存只减了1，造成“超卖”现象。

#### 问题：一般的Mysql能抗住大概多少的并发？

答：几百。所以只用mysql完全扛不住高并发。而redis支持好几万的并发量。



使用redis来对商品库存进行减一操作：

```java
stringRedisTemplate.opsForValue().decrement(........);
```



